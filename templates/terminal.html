<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>{{ container_name }} - 终端 - Containly</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/css/terminal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>

<div class="term-topbar">
  <div class="term-topbar-left">
    <div class="term-traffic-lights">
      <a href="/" class="term-dot term-dot-red" title="返回首页"></a>
      <span class="term-dot term-dot-yellow" id="clear-terminal" title="清空终端"></span>
      <span class="term-dot term-dot-green" id="toggle-fullscreen" title="全屏"></span>
    </div>
    <span class="term-title">{{ container_name }}</span>
    <span class="term-id">{{ container_id[:12] }}</span>
  </div>
  <div class="term-topbar-right">
    <span class="term-status" id="conn-status">● 连接中...</span>
  </div>
</div>

<div class="term-body" id="terminal-output"></div>

<div class="term-input-bar">
  <span class="term-prompt" id="term-prompt">$</span>
  <input type="text" id="command-input" placeholder="输入命令..." autocomplete="off" spellcheck="false" autofocus>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const containerId = "{{ container_id }}";
  const containerName = "{{ container_name }}";
  const output = document.getElementById('terminal-output');
  const input = document.getElementById('command-input');
  const statusEl = document.getElementById('conn-status');
  const clearBtn = document.getElementById('clear-terminal');
  const fullscreenBtn = document.getElementById('toggle-fullscreen');

  let execId = null;
  let history = [];
  let historyIndex = -1;
  let isFullscreen = false;

  // --- Socket.IO 连接 ---
  const socket = io({ transports: ['websocket', 'polling'] });

  socket.on('connect', () => {
    setStatus('connected', '● 已连接');
    socket.emit('terminal_init', { container_id: containerId });
  });

  socket.on('disconnect', () => {
    setStatus('disconnected', '● 已断开');
    appendOutput('\n\r\x1b[31m[连接已断开]\x1b[0m\n');
  });

  socket.on('terminal_ready', (data) => {
    execId = data.exec_id;
    appendOutput(`\x1b[32m已连接到容器: ${containerName}\x1b[0m\n\n`);
  });

  socket.on('terminal_output', (data) => {
    if (data.output) appendOutput(data.output);
  });

  socket.on('terminal_error', (data) => {
    appendOutput(`\n\x1b[31m错误: ${data.error}\x1b[0m\n`);
    setStatus('error', '● 错误');
  });

  // --- 输出渲染 ---
  function appendOutput(text) {
    const el = document.createElement('span');
    el.innerHTML = ansiToHtml(text);
    output.appendChild(el);
    output.scrollTop = output.scrollHeight;
  }

  function ansiToHtml(text) {
    const colorMap = {
      '30': '#555', '31': '#f55', '32': '#5f5', '33': '#ff5',
      '34': '#55f', '35': '#f5f', '36': '#5ff', '37': '#fff',
      '90': '#888', '91': '#f88', '92': '#8f8', '93': '#ff8',
      '94': '#88f', '95': '#f8f', '96': '#8ff', '97': '#fff'
    };

    return text
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/\r\n/g, '\n').replace(/\r/g, '\n')
      .replace(/\x1B\[([0-9;]*)m/g, (_, codes) => {
        if (!codes || codes === '0') return '</span>';
        for (const c of codes.split(';')) {
          if (colorMap[c]) return `<span style="color:${colorMap[c]}">`;
          if (c === '1') return '<span style="font-weight:bold">';
        }
        return '';
      })
      .replace(/\x1B\[[0-9;]*[A-Za-z]/g, '') // strip remaining escape sequences
      .replace(/\n/g, '<br>');
  }

  function setStatus(cls, text) {
    statusEl.className = 'term-status term-status-' + cls;
    statusEl.textContent = text;
  }

  // --- 命令输入 ---
  function sendCommand() {
    const cmd = input.value;
    if (!execId) return;

    if (cmd.trim()) {
      history.push(cmd);
      historyIndex = history.length;
    }

    socket.emit('terminal_input', { exec_id: execId, command: cmd + '\n' });
    input.value = '';
  }

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      sendCommand();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (history.length > 0 && historyIndex > 0) {
        historyIndex--;
        input.value = history[historyIndex];
      }
    } else if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (historyIndex < history.length - 1) {
        historyIndex++;
        input.value = history[historyIndex];
      } else {
        historyIndex = history.length;
        input.value = '';
      }
    } else if (e.key === 'Tab') {
      e.preventDefault();
      // 发送 tab 给 shell 做补全
      if (execId) socket.emit('terminal_input', { exec_id: execId, command: '\t' });
    } else if (e.key === 'c' && e.ctrlKey) {
      e.preventDefault();
      if (execId) socket.emit('terminal_input', { exec_id: execId, command: '\x03' });
    }
  });

  // --- 工具栏 ---
  clearBtn.addEventListener('click', () => { output.innerHTML = ''; });

  fullscreenBtn.addEventListener('click', () => {
    isFullscreen = !isFullscreen;
    document.body.classList.toggle('fullscreen', isFullscreen);
    input.focus();
  });

  // 点击终端区域聚焦输入
  output.addEventListener('click', () => input.focus());

  // ESC 退出全屏
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isFullscreen) {
      isFullscreen = false;
      document.body.classList.remove('fullscreen');
    }
  });
});
</script>
</body>
</html>
