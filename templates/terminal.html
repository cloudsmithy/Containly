<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>{{ container_name }} - 终端 - Containly</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/css/terminal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>

<div class="term-topbar">
  <div class="term-topbar-left">
    <div class="term-traffic-lights">
      <a href="/" class="term-dot term-dot-red" title="返回首页"></a>
      <span class="term-dot term-dot-yellow" id="clear-terminal" title="清空终端"></span>
      <span class="term-dot term-dot-green" id="toggle-fullscreen" title="全屏"></span>
    </div>
    <span class="term-title">{{ container_name }}</span>
    <span class="term-id">{{ container_id[:12] }}</span>
  </div>
  <div class="term-topbar-right">
    <span class="term-status" id="conn-status">● 连接中...</span>
  </div>
</div>

<div class="term-body" id="terminal-output" tabindex="0"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const containerId = "{{ container_id }}";
  const containerName = "{{ container_name }}";
  const output = document.getElementById('terminal-output');
  const statusEl = document.getElementById('conn-status');
  const clearBtn = document.getElementById('clear-terminal');
  const fullscreenBtn = document.getElementById('toggle-fullscreen');

  let execId = null;
  let isFullscreen = false;

  const socket = io({ transports: ['websocket', 'polling'] });

  socket.on('connect', () => {
    setStatus('connected', '● 已连接');
    socket.emit('terminal_init', { container_id: containerId });
  });

  socket.on('disconnect', () => {
    setStatus('disconnected', '● 已断开');
    appendOutput('\r\n\x1b[31m[连接已断开]\x1b[0m\r\n');
  });

  socket.on('terminal_ready', (data) => {
    execId = data.exec_id;
  });

  socket.on('terminal_output', (data) => {
    if (data.output) appendOutput(data.output);
  });

  socket.on('terminal_error', (data) => {
    appendOutput(`\r\n\x1b[31m错误: ${data.error}\x1b[0m\r\n`);
    setStatus('error', '● 错误');
  });

  // --- 输出渲染 ---
  function appendOutput(text) {
    const el = document.createElement('span');
    el.innerHTML = ansiToHtml(text);
    output.appendChild(el);
    output.scrollTop = output.scrollHeight;
  }

  function ansiToHtml(text) {
    const colorMap = {
      '30': '#555', '31': '#f55', '32': '#5f5', '33': '#ff5',
      '34': '#55f', '35': '#f5f', '36': '#5ff', '37': '#fff',
      '90': '#888', '91': '#f88', '92': '#8f8', '93': '#ff8',
      '94': '#88f', '95': '#f8f', '96': '#8ff', '97': '#fff'
    };
    return text
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/\r\n/g, '\n').replace(/\r/g, '')
      .replace(/\x1B\[([0-9;]*)m/g, (_, codes) => {
        if (!codes || codes === '0') return '</span>';
        for (const c of codes.split(';')) {
          if (colorMap[c]) return `<span style="color:${colorMap[c]}">`;
          if (c === '1') return '<span style="font-weight:bold">';
        }
        return '';
      })
      .replace(/\x1B\[[0-9;]*[A-Za-z]/g, '')
      .replace(/\n/g, '<br>');
  }

  function setStatus(cls, text) {
    statusEl.className = 'term-status term-status-' + cls;
    statusEl.textContent = text;
  }

  // --- 键盘输入：直接发给 shell，由 TTY 回显 ---
  output.addEventListener('keydown', (e) => {
    if (!execId) return;

    // 防止浏览器默认行为
    if (e.key === 'Tab') { e.preventDefault(); send('\t'); return; }
    if (e.key === 'ArrowUp') { e.preventDefault(); send('\x1b[A'); return; }
    if (e.key === 'ArrowDown') { e.preventDefault(); send('\x1b[B'); return; }
    if (e.key === 'ArrowRight') { e.preventDefault(); send('\x1b[C'); return; }
    if (e.key === 'ArrowLeft') { e.preventDefault(); send('\x1b[D'); return; }

    if (e.ctrlKey) {
      e.preventDefault();
      const code = e.key.toLowerCase().charCodeAt(0) - 96; // ctrl+c = 3, ctrl+d = 4, etc
      if (code > 0 && code < 27) send(String.fromCharCode(code));
      return;
    }

    if (e.key === 'Enter') { send('\n'); return; }
    if (e.key === 'Backspace') { send('\x7f'); return; }
    if (e.key === 'Escape') {
      if (isFullscreen) { isFullscreen = false; document.body.classList.remove('fullscreen'); }
      else send('\x1b');
      return;
    }
    if (e.key === 'Delete') { send('\x1b[3~'); return; }
    if (e.key === 'Home') { send('\x1b[H'); return; }
    if (e.key === 'End') { send('\x1b[F'); return; }

    // 普通可打印字符
    if (e.key.length === 1 && !e.metaKey && !e.altKey) {
      send(e.key);
    }
  });

  function send(data) {
    socket.emit('terminal_input', { exec_id: execId, command: data });
  }

  // 自动聚焦终端区域
  output.focus();
  output.addEventListener('click', () => output.focus());

  // --- 工具栏 ---
  clearBtn.addEventListener('click', () => { output.innerHTML = ''; output.focus(); });
  fullscreenBtn.addEventListener('click', () => {
    isFullscreen = !isFullscreen;
    document.body.classList.toggle('fullscreen', isFullscreen);
    output.focus();
  });
});
</script>
</body>
</html>
