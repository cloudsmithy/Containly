<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Containly å®¹å™¨é¢æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
:root {
  --bg: linear-gradient(145deg, #e0eafc, #cfdef3);
  --text: #2c3e50;
  --tag-bridge: #17a2b8;
  --tag-host: #6f42c1;
  --status-open: #28a745;
  --status-closed: #dc3545;
  --copy-bg: #fff3cd;
}

body.dark {
  --bg: #121212;
  --text: #f0f0f0;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  padding: 2rem;
  font-family: "Segoe UI", sans-serif;
  background-color: var(--bg);
  color: var(--text);
  transition: background 0.3s, color 0.3s;
}

h1 {
  font-size: 1.8rem;
  margin-bottom: 1rem;
}

input[type="text"] {
  padding: 0.5rem;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  width: 240px;
  outline: none;
}

.top-bar {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.dark-toggle {
  margin-left: auto;
  cursor: pointer;
  padding: 6px 10px;
  border: 1px solid #999;
  border-radius: 6px;
  background-color: transparent;
  font-size: 1rem;
  transition: background 0.2s;
}
.dark-toggle:hover {
  background-color: rgba(255,255,255,0.3);
}

.blacklist-link {
  text-decoration: none;
  color: inherit;
  border: 1px solid #999;
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 1rem;
  transition: background 0.2s;
}
.blacklist-link:hover {
  background-color: rgba(255,255,255,0.3);
}

.section {
  margin-top: 2rem;
}

.section h2 {
  font-size: 1.4rem;
  margin-bottom: 0.5rem;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(330px, 1fr));
  gap: 1.5rem;
  margin-top: 1rem;
}

.card {
  position: relative;
  padding: 1.5rem;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  color: #fff;
  animation: fadeIn 0.6s ease;
}

/* æ¸å˜èƒŒæ™¯è‰² */
.card:nth-child(6n+1) { background: linear-gradient(135deg, #74ebd5, #acb6e5); }
.card:nth-child(6n+2) { background: linear-gradient(135deg, #fbc2eb, #a6c1ee); }
.card:nth-child(6n+3) { background: linear-gradient(135deg, #ffecd2, #fcb69f); }
.card:nth-child(6n+4) { background: linear-gradient(135deg, #c2e9fb, #a1c4fd); }
.card:nth-child(6n+5) { background: linear-gradient(135deg, #f6d365, #fda085); }
.card:nth-child(6n+6) { background: linear-gradient(135deg, #d4fc79, #96e6a1); }

.card h3 {
  font-size: 1.2rem;
  margin-bottom: 0.4rem;
}

.tag {
  background-color: var(--tag-bridge);
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
  display: inline-block;
}

.tag.host {
  background-color: var(--tag-host);
}

.port-list {
  margin-top: 1rem;
}

.port-item {
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
}

.copyable {
  background-color: rgba(255,255,255,0.25);
  padding: 2px 6px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  font-family: monospace;
  transition: background 0.2s;
}
.copyable:hover {
  background-color: var(--copy-bg);
  color: #000;
}

a {
  color: #fff;
  text-decoration: underline;
  font-weight: 500;
}

.status-indicator {
  display: inline-block;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-left: 6px;
}

.toast {
  padding: 8px 16px;
  margin-bottom: 8px;
  color: #fff;
  background-color: rgba(0,0,0,0.7);
  border-radius: 8px;
  animation: fadeToast 0.5s ease-in-out;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  font-size: 0.9rem;
}

@keyframes fadeToast {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}


.open {
  background-color: var(--status-open);
}
.closed {
  background-color: var(--status-closed);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* å³ä¸Šè§’ç«–æ’æŒ‰é’® */
.card-actions {
 position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.card.show-actions .card-actions {
  opacity: 1;
  visibility: visible;
}

.action-btn {
  cursor: pointer;
  border: 1px solid #999;
  border-radius: 6px;
  font-size: 0.75rem;
  background-color: transparent;
  padding: 4px 8px;
  color: #fff;
  transition: background 0.2s;
}
.action-btn:hover {
  background-color: rgba(255,255,255,0.3);
}
  </style>
</head>
<body>
<div id="toast-container" style="
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 9999;
"></div>
  <div class="top-bar">
    <h1>Containly å®¹å™¨é¢æ¿</h1>
    <label for="host-ip">å®¿ä¸»æœº IPï¼š</label>
    <input type="text" id="host-ip" placeholder="ä¾‹å¦‚ 192.168.1.100" />
    <a href="/blacklist" class="blacklist-link">é»‘åå•ç®¡ç†</a>
    <!-- å¤œé—´æ¨¡å¼æŒ‰é’®ï¼Œåˆå§‹æ˜¾ç¤ºâ€œğŸŒœâ€æˆ–â€œğŸŒâ€æ ¹æ®éœ€è¦å¯æ‰‹åŠ¨æ”¹ -->
    <button class="dark-toggle" id="darkBtn">ğŸŒ™</button>
  </div>

  {% for status, containers in grouped.items() %}
<div class="section" data-status="{{ status }}">
  <h2>{{ status|capitalize }} å®¹å™¨</h2>
  <div class="grid">
    {% for c in containers %}
    <div class="card"
         data-container-id="{{ c.id }}"
         data-container-name="{{ c.name }}"
         data-protocol="http">
      <div class="card-actions">
        {% if c.status == "running" %}
        <button class="action-btn stop-btn" data-id="{{ c.id }}">ğŸ›‘</button>
        <button class="action-btn restart-btn" data-id="{{ c.id }}">ğŸ”„</button>
        {% elif c.status == "exited" %}
        <button class="action-btn start-btn" data-id="{{ c.id }}">â–¶ï¸</button>
        {% endif %}
        <button class="action-btn protocol-btn">ğŸ”</button>
        <button class="action-btn blacklist-btn">ğŸš«</button>
      </div>

      <h3>{{ c.name }}</h3>
      <div class="tag {{ 'host' if c.network == 'host' else '' }}">{{ c.network }}</div>
      <div class="port-list">
        {% for p in c.ports %}
        <div class="port-item" data-host="{{ p.host_port }}" data-container="{{ p.container_port }}">
          Host: <span class="copyable host-port">{{ p.host_port }}</span> |
          Container: <span class="copyable container-port">{{ p.container_port }}</span> â€“
          <a href="#" class="port-link" target="_blank">è·³è½¬</a>
          <span class="status-indicator" title="æ£€æµ‹ä¸­..."></span>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endfor %}


  <script>
    const ipInput = document.getElementById("host-ip");
    ipInput.value = localStorage.getItem("host_ip") || "";

    /* å¤œé—´æ¨¡å¼: ç”¨æ—¥/æœˆå›¾æ ‡ */
    function toggleDark() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      document.getElementById("darkBtn").textContent = isDark ? "â˜€ï¸" : "ğŸŒ™";
    }

    /* æ›´æ–°ç«¯å£é“¾æ¥ + åœ¨çº¿æ£€æµ‹ */
function updateLinks() {
  const ip = ipInput.value.trim();
  localStorage.setItem("host_ip", ip);

  document.querySelectorAll(".card").forEach(card => {
    const protocol = card.dataset.protocol || "http";
    const containerName = card.dataset.containerName;

    card.querySelectorAll(".port-item").forEach(item => {
      const port = item.dataset.host;
      const link = item.querySelector(".port-link");
      const indicator = item.querySelector(".status-indicator");

      if (ip && port) {
        const url = `${protocol}://${ip}:${port}`;
        link.href = url;
        link.textContent = url;

        fetch(url, { method: 'HEAD', mode: 'no-cors' })
          .then(() => {
            indicator.classList.add("open");
            indicator.classList.remove("closed");
            indicator.title = "ç«¯å£åœ¨çº¿";
          })
          .catch(() => {
            indicator.classList.add("closed");
            indicator.classList.remove("open");
            indicator.title = "ç«¯å£ä¸å¯è¾¾";
          });
      } else {
        link.href = "#";
        link.textContent = "è·³è½¬";
        indicator.classList.remove("open", "closed");
        indicator.title = "";
      }
    });
  });
}

    /* å¤åˆ¶ç«¯å£å· */
    function enableCopy() {
      document.querySelectorAll(".copyable").forEach(el => {
        el.addEventListener("click", () => {
          navigator.clipboard.writeText(el.textContent.trim());
          el.style.backgroundColor = "#c1f0d1";
          setTimeout(() => {
            el.style.backgroundColor = "";
          }, 600);
        });
      });
    }

    /* å¯åŠ¨/åœæ­¢/é‡å¯ */
function initContainerActions() {
  function moveCard(containerId, fromStatus, toStatus) {
    const card = document.querySelector(`.card[data-container-id="${containerId}"]`);
    const fromSection = document.querySelector(`.section[data-status="${fromStatus}"] .grid`);
    const toSection = document.querySelector(`.section[data-status="${toStatus}"] .grid`);

    if (card && toSection) {
      card.remove();
      toSection.prepend(card);
    }
  }

function refreshContainerStatus(containerId) {
  fetch(`/container/${containerId}/status`)
    .then(res => res.json())
    .then(data => {
      const running = data.running;
      const card = document.querySelector(`.card[data-container-id="${containerId}"]`);
      if (!card) return;

      // é‡æ–°è®¾ç½®æŒ‰é’®ç»„
      const actionsDiv = card.querySelector(".card-actions");
      actionsDiv.innerHTML = running ? `
        <button class="action-btn stop-btn" data-id="${containerId}">ğŸ›‘</button>
        <button class="action-btn restart-btn" data-id="${containerId}">ğŸ”„</button>
        <button class="action-btn protocol-btn">${card.dataset.protocol === "http" ? "ğŸ”" : "ğŸ”“"}</button>
        <button class="action-btn blacklist-btn">ğŸš«</button>
      ` : `
        <button class="action-btn start-btn" data-id="${containerId}">â–¶ï¸</button>
        <button class="action-btn protocol-btn">${card.dataset.protocol === "http" ? "ğŸ”" : "ğŸ”“"}</button>
        <button class="action-btn blacklist-btn">ğŸš«</button>
      `;

      // é‡æ–°ç»‘å®šäº‹ä»¶ï¼ˆæŒ‰é’®äº‹ä»¶ï¼‰
      initContainerActions();
      initProtocolToggle();
      initBlacklist();

      // æ›´æ–°å®¹å™¨æ‰€åœ¨åŒºåŸŸ
      const fromStatus = running ? "exited" : "running";
      const toStatus = running ? "running" : "exited";
      const fromSection = document.querySelector(`.section[data-status="${fromStatus}"] .grid`);
      const toSection = document.querySelector(`.section[data-status="${toStatus}"] .grid`);

      if (fromSection && toSection) {
        card.remove();
        toSection.prepend(card);
      }

      // ç¡®ä¿é“¾æ¥çŠ¶æ€æ­£ç¡®
      updateLinks();
    })
    .catch(err => console.error("åˆ·æ–°çŠ¶æ€å¤±è´¥", err));
}

  function performAction(containerId, action, successMsg) {
    fetch(`/container/${containerId}/${action}`, { method: "POST" })
      .then(res => {
        if (res.ok) {
          showToast(` ${successMsg}`);
          setTimeout(() => refreshContainerStatus(containerId), 1000);
        } else throw new Error(`${action}æ“ä½œå¤±è´¥`);
      })
      .catch(err => showToast(`âŒ ${err.message}`));
  }

  document.querySelectorAll(".start-btn").forEach(btn => {
    btn.onclick = () => performAction(btn.dataset.id, "start", "å®¹å™¨å·²å¯åŠ¨");
  });

  document.querySelectorAll(".stop-btn").forEach(btn => {
    btn.onclick = () => performAction(btn.dataset.id, "stop", "å®¹å™¨å·²åœæ­¢");
  });

  document.querySelectorAll(".restart-btn").forEach(btn => {
    btn.onclick = () => performAction(btn.dataset.id, "restart", "å®¹å™¨å·²é‡å¯");
  });
}


    /* HTTP/HTTPSåˆ‡æ¢ + æŒ‰é’®æ–‡å­— */
function initProtocolToggle() {
  document.querySelectorAll(".card").forEach(card => {
    const containerName = card.dataset.containerName;
    const btn = card.querySelector(".protocol-btn");

    // åŠ è½½ä¿å­˜çš„åè®®çŠ¶æ€
    const storedProtocol = localStorage.getItem(`protocol_${containerName}`) || "http";
    card.dataset.protocol = storedProtocol;
    btn.textContent = storedProtocol === "http" ? "ğŸ”" : "ğŸ”“";

    btn.addEventListener("click", () => {
      const current = card.dataset.protocol;
      const newProtocol = current === "http" ? "https" : "http";
      card.dataset.protocol = newProtocol;
      btn.textContent = newProtocol === "http" ? "ğŸ”" : "ğŸ”“";

      // ä¿å­˜åˆ° localStorage
      localStorage.setItem(`protocol_${containerName}`, newProtocol);

      updateLinks();
    });
  });
}


    /* æ‹‰é»‘å®¹å™¨ (å‰ç«¯ localStorage) */
    function initBlacklist() {
      const blacklisted = JSON.parse(localStorage.getItem("blacklisted_containers") || "[]");

      // éšè—å·²æ‹‰é»‘çš„å¡ç‰‡
      document.querySelectorAll(".card").forEach(card => {
        const name = card.dataset.containerName;
        if (blacklisted.includes(name)) {
          card.style.display = "none";
        }
      });

      // ç‚¹å‡»æ‹‰é»‘
      document.querySelectorAll(".blacklist-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const card = btn.closest(".card");
          const name = card.dataset.containerName;
          if (!blacklisted.includes(name)) {
            blacklisted.push(name);
            localStorage.setItem("blacklisted_containers", JSON.stringify(blacklisted));
          }
          card.style.display = "none";
        });
      });
    }


function initCardToggleActions() {
  document.querySelectorAll(".card").forEach(card => {
    let isActionsVisible = false;

    card.addEventListener("click", (e) => {
      if (e.target.classList.contains('action-btn')) return;
      isActionsVisible = !isActionsVisible;
      card.classList.toggle("show-actions", isActionsVisible);
    });

    card.addEventListener("mouseenter", () => {
      card.classList.add("show-actions");
    });

    card.addEventListener("mouseleave", () => {
      if (!isActionsVisible) {
        card.classList.remove("show-actions");
      }
    });
  });
}

function showToast(msg, duration = 500) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = msg;
  document.getElementById("toast-container").appendChild(toast);
  setTimeout(() => toast.remove(), duration);
}

    // DOM åŠ è½½å

    window.addEventListener("DOMContentLoaded", () => {
      // æ¢å¤å¤œé—´æ¨¡å¼
      const theme = localStorage.getItem("theme");
      if (theme === "dark") {
        document.body.classList.add("dark");
        document.getElementById("darkBtn").textContent = "â˜€ï¸";
      } else {
        document.getElementById("darkBtn").textContent = "ğŸŒ™";
      }

      // ç»‘å®šå¤œé—´æ¨¡å¼åˆ‡æ¢
      document.getElementById("darkBtn").addEventListener("click", toggleDark);

      enableCopy();
      initContainerActions();
      initProtocolToggle();
      initBlacklist();
      updateLinks();
      initCardToggleActions();
      initCardToggleActions(); // â† æ–°å¢è¿™ä¸€è¡Œ

      ipInput.addEventListener("input", updateLinks);
    });
  </script>
</body>
</html>