<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Containly é•œåƒç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="stylesheet" href="/static/css/colors.css">
</head>
<body>
<div id="toast-container" style="
  position: fixed;
  top: 16px;
  right: 16px;
  z-index: 9999;
"></div>

<div class="top-bar">
  <h1>ğŸ“¦ é•œåƒç®¡ç†</h1>
  <a href="/" class="nav-link">â† è¿”å›å®¹å™¨é¢æ¿</a>
  <button class="dark-toggle" id="darkBtn">ğŸŒ™</button>
</div>

<!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
<div id="main-loader" class="main-loader">
  <div class="loader"></div>
  <div class="loader-text">åŠ è½½é•œåƒä¿¡æ¯...</div>
</div>

<!-- é•œåƒåˆ—è¡¨åŒºåŸŸ -->
<div class="section">
  <h2>Docker é•œåƒ</h2>
  <div class="grid" id="images-grid">
    <div class="empty-state">åŠ è½½ä¸­...</div>
  </div>
</div>

<!-- ç¡®è®¤å¯¹è¯æ¡† -->
<div class="confirm-dialog" id="confirm-dialog">
  <div class="confirm-dialog-content">
    <h3>ç¡®è®¤æ“ä½œ</h3>
    <p id="confirm-message">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
    <div class="confirm-buttons">
      <button id="confirm-cancel">å–æ¶ˆ</button>
      <button id="confirm-ok">ç¡®å®š</button>
    </div>
  </div>
</div>

<script>
// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener("DOMContentLoaded", () => {
  // åˆå§‹åŒ–ä¸»é¢˜
  initTheme();
  
  // åŠ è½½é•œåƒæ•°æ®
  loadImages();
  
  // åˆå§‹åŒ–ç¡®è®¤å¯¹è¯æ¡†
  initConfirmDialog();
});

// åˆå§‹åŒ–ä¸»é¢˜
function initTheme() {
  const theme = localStorage.getItem("theme");
  const darkBtn = document.getElementById("darkBtn");
  
  if (theme === "dark") {
    document.body.classList.add("dark");
    darkBtn.textContent = "â˜€ï¸";
  } else {
    darkBtn.textContent = "ğŸŒ™";
  }
  
  darkBtn.addEventListener("click", () => {
    document.body.classList.toggle("dark");
    const isDark = document.body.classList.contains("dark");
    localStorage.setItem("theme", isDark ? "dark" : "light");
    darkBtn.textContent = isDark ? "â˜€ï¸" : "ğŸŒ™";
  });
}

// åŠ è½½é•œåƒæ•°æ®
function loadImages() {
  // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
  document.getElementById("main-loader").style.display = "flex";
  
  fetch("/api/images/all")
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // æ¸²æŸ“é•œåƒæ•°æ®
        renderImages(data.images);
        
        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        document.getElementById("main-loader").style.display = "none";
      } else {
        showToast(`åŠ è½½é•œåƒå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
      }
    })
    .catch(error => {
      showToast(`è¯·æ±‚é”™è¯¯: ${error.message}`);
      document.getElementById("main-loader").style.display = "none";
    });
}

// æ¸²æŸ“é•œåƒæ•°æ®
function renderImages(images) {
  const grid = document.getElementById("images-grid");
  
  if (!images || images.length === 0) {
    grid.innerHTML = `<div class="empty-state">æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é•œåƒ</div>`;
    return;
  }
  
  // æ¸…ç©ºç°æœ‰å†…å®¹
  grid.innerHTML = '';
  
  // ä¸ºæ¯ä¸ªé•œåƒåˆ›å»ºå¡ç‰‡
  images.forEach((image, index) => {
    const card = createImageCard(image, index);
    grid.appendChild(card);
  });
}

// åˆ›å»ºé•œåƒå¡ç‰‡
function createImageCard(image, index) {
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.imageId = image.id;
  card.dataset.index = index % 6;
  
  // ä½¿ç”¨ä¸å®¹å™¨å¡ç‰‡ç›¸åŒçš„é¢œè‰²ç±»ï¼Œä½†ä½¿ç”¨ "other" çŠ¶æ€çš„é¢œè‰²
  card.classList.add(`other-card-${index % 6}`);
  
  // åˆ¤æ–­æ˜¯å¦æœ‰å®¹å™¨åœ¨ä½¿ç”¨æ­¤é•œåƒ
  const hasContainers = image.containers && image.containers.length > 0;
  
  // åˆ›å»ºæ ‡ç­¾åˆ—è¡¨
  let tagsHtml = '';
  image.tags.forEach(tag => {
    tagsHtml += `<div class="tag">${tag}</div>`;
  });
  
  // åˆ›å»ºå®¹å™¨åˆ—è¡¨
  let containersHtml = '';
  if (hasContainers) {
    containersHtml = '<div class="container-list"><h4>ä½¿ç”¨æ­¤é•œåƒçš„å®¹å™¨:</h4><ul>';
    image.containers.forEach(container => {
      const statusClass = container.status === 'running' ? 'running' : 'stopped';
      containersHtml += `<li class="${statusClass}">${container.name} (${container.status})</li>`;
    });
    containersHtml += '</ul></div>';
  }
  
  card.innerHTML = `
    <div class="card-actions">
      <button class="action-btn delete-btn" data-id="${image.id}" title="åˆ é™¤é•œåƒ" ${hasContainers ? 'disabled' : ''}>ğŸ—‘ï¸</button>
    </div>
    <h3>${image.tags[0] || 'æ— æ ‡ç­¾'}</h3>
    <div class="image-id">${image.short_id}</div>
    <div class="image-info">
      <div class="image-size">å¤§å°: ${image.size} MB</div>
      <div class="image-created">åˆ›å»ºæ—¶é—´: ${new Date(image.created).toLocaleString()}</div>
    </div>
    ${containersHtml}
  `;
  
  // æ·»åŠ åˆ é™¤é•œåƒäº‹ä»¶
  const deleteBtn = card.querySelector(".delete-btn");
  if (deleteBtn && !hasContainers) {
    deleteBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      
      // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
      showConfirmDialog(
        `ç¡®å®šè¦åˆ é™¤é•œåƒ ${image.tags[0] || image.short_id} å—ï¼Ÿ`,
        () => {
          deleteImage(image.id, card);
        }
      );
    });
  }
  
  return card;
}

// åˆ é™¤é•œåƒ
function deleteImage(imageId, card) {
  // æ·»åŠ åŠ è½½ç‰¹æ•ˆ
  addLoadingOverlay(card, "æ­£åœ¨åˆ é™¤é•œåƒ...");
  
  fetch(`/api/delete/image/${imageId}`, { method: 'DELETE' })
    .then(response => {
      if (!response.ok) {
        throw new Error(`æ“ä½œå¤±è´¥: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
        card.classList.add("card-fading");
        
        // å»¶è¿Ÿåç§»é™¤å¡ç‰‡
        setTimeout(() => {
          card.remove();
          
          // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é•œåƒ
          const grid = document.getElementById("images-grid");
          if (grid.children.length === 0) {
            grid.innerHTML = `<div class="empty-state">æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é•œåƒ</div>`;
          }
        }, 500);
        
        showToast("é•œåƒåˆ é™¤æˆåŠŸ");
      } else {
        // ç§»é™¤åŠ è½½ç‰¹æ•ˆ
        removeLoadingOverlay(card);
        showToast(`åˆ é™¤å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
      }
    })
    .catch(error => {
      // ç§»é™¤åŠ è½½ç‰¹æ•ˆ
      removeLoadingOverlay(card);
      showToast(`è¯·æ±‚é”™è¯¯: ${error.message}`);
      console.error("åˆ é™¤é•œåƒé”™è¯¯:", error);
    });
}

// ç¡®è®¤å¯¹è¯æ¡†å›è°ƒ
let _confirmCallback = null;

// åˆå§‹åŒ–ç¡®è®¤å¯¹è¯æ¡†
function initConfirmDialog() {
  const dialog = document.getElementById("confirm-dialog");
  const cancelBtn = document.getElementById("confirm-cancel");
  const okBtn = document.getElementById("confirm-ok");

  const closeDialog = () => {
    dialog.classList.remove("active");
    _confirmCallback = null;
  };

  cancelBtn.addEventListener("click", closeDialog);

  okBtn.addEventListener("click", () => {
    dialog.classList.remove("active");
    if (_confirmCallback) _confirmCallback();
    _confirmCallback = null;
  });

  dialog.addEventListener("click", (e) => {
    if (e.target === dialog) closeDialog();
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && dialog.classList.contains("active")) closeDialog();
  });
}

// æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
function showConfirmDialog(message, callback) {
  const dialog = document.getElementById("confirm-dialog");
  const messageEl = document.getElementById("confirm-message");
  if (!dialog || !messageEl) return;

  messageEl.textContent = message;
  _confirmCallback = callback;
  dialog.classList.add("active");
}

// æ·»åŠ åŠ è½½ç‰¹æ•ˆè¦†ç›–å±‚
function addLoadingOverlay(card, message) {
  // åˆ›å»ºåŠ è½½è¦†ç›–å±‚
  const overlay = document.createElement("div");
  overlay.className = "card-loading";
  overlay.innerHTML = `
    <div class="loader"></div>
    <div class="card-loading-text">${message}</div>
  `;
  
  // æ·»åŠ åˆ°å¡ç‰‡
  card.appendChild(overlay);
}

// ç§»é™¤åŠ è½½ç‰¹æ•ˆè¦†ç›–å±‚
function removeLoadingOverlay(card) {
  const overlay = card.querySelector(".card-loading");
  if (overlay) {
    overlay.remove();
  }
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(msg, duration = 3000) {
  // è·å–æˆ–åˆ›å»º toast å®¹å™¨
  let toastContainer = document.getElementById("toast-container");
  if (!toastContainer) {
    toastContainer = document.createElement("div");
    toastContainer.id = "toast-container";
    toastContainer.style.position = "fixed";
    toastContainer.style.top = "10px";
    toastContainer.style.right = "10px";
    toastContainer.style.zIndex = "9999";
    document.body.appendChild(toastContainer);
  }
  
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = msg;
  toastContainer.appendChild(toast);
  
  if (duration > 0) {
    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
      }
    }, duration);
  }
}
</script>

<style>
/* å®¹å™¨åˆ—è¡¨æ ·å¼ */
.container-list {
  border-top: 1px solid var(--border-color);
  padding-top: 10px;
  margin-top: 10px;
}

.container-list h4 {
  margin-top: 0;
  margin-bottom: 8px;
  font-size: 0.9em;
}

.container-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.container-list li {
  padding: 3px 0;
  font-size: 0.85em;
}

.container-list li.running {
  color: var(--status-running);
}

.container-list li.stopped {
  color: var(--status-exited);
}

/* é•œåƒä¿¡æ¯æ ·å¼ */
.image-id {
  font-family: monospace;
  margin-bottom: 10px;
  font-size: 0.9em;
  color: var(--text-secondary);
}

.image-info {
  margin-bottom: 10px;
  font-size: 0.9em;
}

.image-size, .image-created {
  margin-bottom: 5px;
}
</style>
</body>
</html>
